#!/usr/bin/env bash
set -euo pipefail

OUT_DIR="data"
OUT_FILE="$OUT_DIR.tar.gz"
ENC_FILE="$OUT_FILE.enc"

if [[ ! -f "$ENC_FILE" ]]; then
    echo "Error: '$ENC_FILE' does not exist. Nothing to decrypt."
    exit 1
fi

if [[ -d "$OUT_DIR" ]]; then
    echo "Error: '$OUT_DIR' directory already exists. Already decrypted."
    exit 1
fi

echo -n "Enter decryption password: "
read -s PASSWORD
echo

openssl enc -d -aes-256-cbc -pbkdf2 -in "$ENC_FILE" -out "$OUT_FILE" -pass pass:"$PASSWORD"

mkdir -p "$OUT_DIR"

echo "Extracting contents into '$OUT_DIR' directory..."
tar -xzf "$OUT_FILE" -C "$OUT_DIR"

echo "Decryption and extraction complete. Contents are in '$OUT_DIR' directory."
shred -u -n 5 -z "$ENC_FILE" "$OUT_FILE"